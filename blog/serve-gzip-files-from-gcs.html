<!DOCTYPE html> <html lang=en > <meta charset=utf-8 > <link href="https://jaro.blog/feeds/all.atom.xml" type="application/atom+xml" rel=alternate  title="jaro.blog Full Atom Feed"> <link href="https://jaro.blog/feeds/web-development.atom.xml" type="application/atom+xml" rel=alternate  title="jaro.blog Categories Atom Feed"> <meta name=viewport  content="width=device-width, initial-scale=1.0, maximum-scale=5.0"> <meta http-equiv=X-UA-Compatible  content="ie=edge"> <meta name=description  content="Jaro.blog is mostly a technical blog about (but not limited to) different programming topics in various areas (like Linux kernel programming, web development and more)."> <title>jaro.blog - Serving compressed files from Google Cloud Storage</title> <link rel=icon  href="https://jaro.blog/theme/img/favicon.ico" sizes="16x16 24x24 32x32 64x64 128x128" type="image/png"> <link href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css" rel=stylesheet > <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel=stylesheet > <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel=stylesheet  integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin=anonymous > <link href="https://jaro.blog/theme/css/pygment.css" rel=stylesheet > <link href="https://jaro.blog/theme/css/minimal.css" rel=stylesheet > <script src="https://jaro.blog/theme/js/minimal.js"></script> <meta name=tags  content="Google Cloud Storage" /> <meta name=tags  content=gzip  /> <meta name=tags  content="tips&tricks" /> <nav class=navbar  role=navigation  aria-label="main navigation"> <div class=container > <div class=navbar-brand > <a class=navbar-item  href="https://jaro.blog/"> <img src="https://jaro.blog/theme/img/logo.png" alt=jaro.blog > </a> <span class="navbar-burger burger" data-target=navbarMenu  aria-label=menu  aria-expanded=false > <span aria-hidden=true ></span> <span aria-hidden=true ></span> <span aria-hidden=true ></span> </span> </div> <div id=navbarMenu  class=navbar-menu > <div class=navbar-end > <a class="navbar-item is-active" href="https://jaro.blog/"> Home </a> <a class=navbar-item  href="https://jaro.blog/pages/about.html"> About me </a> <div class="navbar-item has-dropdowns is-hoverable"> <a class=navbar-link > Categories </a> <div class=navbar-dropdown > <a class="navbar-item is-active" href="https://jaro.blog/category/web-development.html"> Web development </a> </div> </div> </div> </div> </div> </nav> <section class="hero is-light is-small"> <div class=hero-body > <div class="container has-text-centered"> <h2 class=subtitle > Category: <a href="https://jaro.blog/category/web-development.html">Web development</a> </h2> </div> </div> </section> <section class="section articles"> <div class=container > <article class="card article"> <div class=card-content > <div class=article-header > <div class=has-text-centered > <h2 class="title article-title"> <a href="https://jaro.blog/blog/serve-gzip-files-from-gcs.html" rel=bookmark  title="Permalink to Serving compressed files from Google Cloud Storage"> Serving compressed files from Google Cloud Storage </a> </h2> <p class="subtitle is-6 article-subtitle"> <a href="https://jaro.blog/author/jaroslaw-wierzbicki.html">Jarosław Wierzbicki</a>, on <time class=published  datetime="2020-01-14T00:00:00+08:00"> Tue 14 January 2020 </time> </p> </div> <div class="tags are-medium is-centered"> <span class="tag is-link is-light"> <a href="https://jaro.blog/tag/google-cloud-storage.html">Google Cloud Storage</a> </span> <span class="tag is-link is-light"> <a href="https://jaro.blog/tag/gzip.html">gzip</a> </span> <span class="tag is-link is-light"> <a href="https://jaro.blog/tag/tipstricks.html">tips&tricks</a> </span> </div> </div> <div class="content article-body"> <p>Recently I’ve been looking into some ways to optimise the loading speed of a website that I’m working on. One of the possible improvements suggested by Chromium’s <a href="https://developers.google.com/web/tools/lighthouse">Audit</a> tool was to <a href="https://web.dev/uses-text-compression">enable text compression</a>. An obvious thing to do, one might say, but the question is not whether to do it at all but rather how to do it.</p> <p>Let’s start from the beginning though. The idea is simple. Instead of serving plain text files like CSS and JavaScript to the browser, those files should be sent compressed so that the browser, upon receiving them, can decompress them to a plain text format. There is, of course, a CPU time cost to this approach but in most cases the savings from the data transfer outweigh it by a large margin.<sup><a href="#r1">1</a></sup> This is particularly true for mobile devices where the bandwidth is often limited.</p> <p>Many servers nowadays support compression (be that dynamic or static) and there are plenty of resources describing how to enable it but for some reason I couldn’t quickly find information on how exactly to do it for Google Cloud Storage.</p> <h3>Google Cloud Storage</h3> <p><a href="https://cloud.google.com/storage/">Google Cloud Storage</a> (GCS) by default serves files uncompressed. There is however an option to enable <a href="https://en.wikipedia.org/wiki/Gzip">gzip</a> compression for selected files. There is a catch though. It’s only possible to use static compression which means that the files need to be uploaded already compressed to the storage. Some servers allow you to use dynamic compression which means that they will compress files on the fly when the files are requested by a client but unfortunately GCS, as I mentioned, doesn't do this.</p> <p>So how to do it in GCS, you might ask. Turns out Google makes it extremely easy to compress files upon uploading using their <a href="https://cloud.google.com/storage/docs/gsutil"><code>gsutil</code></a> tool.</p> <p>There are two ways to upload multiple files at a time to Google Cloud Storage using the <code>gsutil</code> command. The first is to use <code>rsync</code> and the other one is to use the <code>cp</code> sub-command.<sup><a href="#r2">2</a></sup> Usually <code>rsync</code> is more convenient but in this case we need to use <code>cp</code> because the former doesn’t support compressing files during the upload (well that’s not exactly true, read further what the <code>-j</code> option does and why it's not applicable here).</p> <p>Let's get to business. Using the <code>cp</code> sub-command is really easy, e.g.:</p> <div class=highlight ><pre><span></span>$ gsutil -m cp -z css,js,map <span class=o >[</span>LOCAL_DIR<span class=o >]</span> gs://<span class=o >[</span>BUCKET<span class=o >]</span>/<span class=o >[</span>REMOTE_DIR<span class=o >]</span>
</pre></div> <p>Let’s break it down:</p> <dl> <dt><code>-m</code> <dd>This option tells the `cp` sub-command to run in parallel. While this is not really needed here, it can greatly shorten the upload time so it's a good idea to use it. <dt><code>-z [ext,...]</code><dt> <dd>Causes all files with given extensions to be compressed before the upload and keeps them like that afterwards (this is how it differs from the <code>-j</code> option which only compresses files for the duration of the upload process and decompresses them at the destination).<br> Beyond compressing of the files, the command will also apply the required attributes to the stored files needed to properly serve them compressed.<sup><a href="#r3">3</a></sup><br> In our example, all CSS, JS and MAP files will be stored compressed (using gzip). <dt><code>LOCAL_DIR</code> <dd>The directory path to the files we want to upload to Google Cloud Storage.<dd> <dt><code>BUCKET</code> <dd>Name of the Google Cloud Storage bucket.<dd> <dt><code>REMOTE_DIR</code> <dd>Remote directory in the bucket that the files will be copied to.<dd> </dl> <p>If you have public access configured to your bucket, you can test if the files are served compressed by opening a link to one of them in your browser (if not, then you'll need to find a way to do it in your particular case by yourself):</p> <div class=highlight ><pre><span></span>https://storage.googleapis.com/[BUCKET_NAME]/[FILE_PATH]
</pre></div> <p>and checking (for example, by using the web browser's development tools) if the response contains <code>content-encoding: gzip</code> and <code>content-type: text/css</code> (for CSS) headers, e.g.:</p> <p><img alt="GCS Response Header with GZIP" src="https://jaro.blog/blog/images/gcs_gzip_resp.png" /></p> <p>If it does, then all is working as intended and we're home. That’s it, so simple, isn’t it?</p> <h3>Conclusion</h3> <p>Gzip compression of static files can significantly speed up loading of your website especially if it’s a fairly complex one with a lot of CSS and JS files. Luckily, if you’re using Google Cloud Storage, there’s really very little work needed to make it happen. Adding only one option to the 'gsutil' command can make your website load noticeably faster. There’s really no argument not do it. ;)</p> <h3>Further Reading</h3> <p><a name=r1 >[1]</a> <a href="https://royal.pingdom.com/can-gzip-compression-really-improve-web-performance/">Can gzip Compression Really Improve Web Performance?</a><br> <a name=r2 >[2]</a> <a href="https://cloud.google.com/storage/docs/transcoding">Transcoding of gzip-compressed files</a><br> <a name=r3 >[3]</a> <a href="https://cloud.google.com/storage/docs/gsutil/commands/cp">gsutil cp command documentation</a></p> </div> </div> </article> </div> </section> <footer class="footer is-dark"> <div class="social has-text-centered"> <a href="https://www.facebook.com/jwierzbi"> <i class="fa fa-facebook-square fa-2x" style="color: #4267b2;" aria-hidden=true ></i> </a> <a href="https://www.instagram.com/wierzbicki.jaroslaw/"> <i class="fa fa-instagram fa-2x" style="color: #000;" aria-hidden=true ></i> </a> <a href="https://twitter.com/j_wierzbicki"> <i class="fa fa-twitter-square fa-2x" style="color: #1da1f2;" aria-hidden=true ></i> </a> <a href="https://github.com/jwierzbi"> <i class="fa fa-github-square fa-2x" style="color: #000;" aria-hidden=true ></i> </a> <a href="https://www.linkedin.com/in/jaroslaw-wierzbicki-14845043"> <i class="fa fa-linkedin-square fa-2x" style="color: #0077b5;" aria-hidden=true ></i> </a> </div> <div class="content has-text-centered"> <p> Copyright &copy; Jarosław Wierzbicki. The source code is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>. The website content is licensed <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>. </p> </div> </footer>